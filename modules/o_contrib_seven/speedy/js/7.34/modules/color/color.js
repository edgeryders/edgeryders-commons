(function($){Drupal.behaviors.color={attach:function(context,settings){var i,j,colors,field_name;var form=$("#system-theme-settings .color-form",context).once("color");if(form.length==0){return}var inputs=[];var hooks=[];var locks=[];var focused=null;$(form).prepend('<div id="placeholder"></div>').addClass("color-processed");var farb=$.farbtastic("#placeholder");var reference=settings.color.reference;for(i in reference){reference[i]=farb.RGBToHSL(farb.unpack(reference[i]))}var height=[];var width=[];for(i in settings.gradients){$("#preview").once("color").append('<div id="gradient-'+i+'"></div>');var gradient=$("#preview #gradient-"+i);height.push(parseInt(gradient.css("height"),10)/10);width.push(parseInt(gradient.css("width"),10)/10);for(j=0;j<(settings.gradients[i]["direction"]=="vertical"?height[i]:width[i]);++j){gradient.append('<div class="gradient-line"></div>')}}if(navigator.appVersion.match(/MSIE [0-6]\./)){var e=$("#preview #img")[0];var image=e.currentStyle.backgroundImage;e.style.backgroundImage="none";e.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=crop, src='"+image.substring(5,image.length-2)+"')"}$("#edit-scheme",form).change(function(){var schemes=settings.color.schemes,colorScheme=this.options[this.selectedIndex].value;if(colorScheme!=""&&schemes[colorScheme]){colors=schemes[colorScheme];for(field_name in colors){callback($("#edit-palette-"+field_name),colors[field_name],false,true)}preview()}});function preview(){Drupal.color.callback(context,settings,form,farb,height,width)}function shift_color(given,ref1,ref2){given=farb.RGBToHSL(farb.unpack(given));given[0]+=ref2[0]-ref1[0];if(ref1[1]==0||ref2[1]==0){given[1]=ref2[1]}else{var d=ref1[1]/ref2[1];if(d>1){given[1]/=d}else{given[1]=1-(1-given[1])*d}}if(ref1[2]==0||ref2[2]==0){given[2]=ref2[2]}else{var d=ref1[2]/ref2[2];if(d>1){given[2]/=d}else{given[2]=1-(1-given[2])*d}}return farb.pack(farb.HSLToRGB(given))}function callback(input,color,propagate,colorScheme){var matched;$(input).css({backgroundColor:color,color:farb.RGBToHSL(farb.unpack(color))[2]>.5?"#000":"#fff"});if($(input).val()&&$(input).val()!=color){$(input).val(color);if(propagate){i=input.i;for(j=i+1;;++j){if(!locks[j-1]||$(locks[j-1]).is(".unlocked"))break;matched=shift_color(color,reference[input.key],reference[inputs[j].key]);callback(inputs[j],matched,false)}for(j=i-1;;--j){if(!locks[j]||$(locks[j]).is(".unlocked"))break;matched=shift_color(color,reference[input.key],reference[inputs[j].key]);callback(inputs[j],matched,false)}preview()}if(!colorScheme){resetScheme()}}}function resetScheme(){$("#edit-scheme",form).each(function(){this.selectedIndex=this.options.length-1})}function focus(){var input=this;focused&&$(focused).unbind("keyup",farb.updateValue).unbind("keyup",preview).unbind("keyup",resetScheme).parent().removeClass("item-selected");focused=this;farb.linkTo(function(color){callback(input,color,true,false)});farb.setColor(this.value);$(focused).keyup(farb.updateValue).keyup(preview).keyup(resetScheme).parent().addClass("item-selected")}$("#palette input.form-text",form).each(function(){this.key=this.id.substring(13);farb.linkTo(function(){}).setColor("#000").linkTo(this);var i=inputs.length;if(inputs.length){var lock=$('<div class="lock"></div>').toggle(function(){$(this).addClass("unlocked");$(hooks[i-1]).attr("class",locks[i-2]&&$(locks[i-2]).is(":not(.unlocked)")?"hook up":"hook");$(hooks[i]).attr("class",locks[i]&&$(locks[i]).is(":not(.unlocked)")?"hook down":"hook")},function(){$(this).removeClass("unlocked");$(hooks[i-1]).attr("class",locks[i-2]&&$(locks[i-2]).is(":not(.unlocked)")?"hook both":"hook down");$(hooks[i]).attr("class",locks[i]&&$(locks[i]).is(":not(.unlocked)")?"hook both":"hook up")});$(this).after(lock);locks.push(lock)}var hook=$('<div class="hook"></div>');$(this).after(hook);hooks.push(hook);$(this).parent().find(".lock").click();this.i=i;inputs.push(this)}).focus(focus);$("#palette label",form);focus.call(inputs[0]);preview()}}})(jQuery);